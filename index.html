<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Progress Visualizer</title>
    <link rel="icon" href="data:," />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50 p-4">
    <div id="app" class="max-w-4xl mx-auto">
      <!-- Simple semester selector and visualization -->
    </div>

    <script>
      // Simple state management
      const state = {
        currentSemester: null,
        semesterData: {},
        students: [],
        currentStudent: null
      };

      // Data loader
      async function loadSemesterData(semester) {
        const path = `./public/${semester}.xlsx`;

        try {
          const response = await fetch(path);
          if (!response.ok) {
            throw new Error(`Failed to fetch ${path}: ${response.status}`);
          }

          const arrayBuffer = await response.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });

          // Get the first sheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];

          // Convert to JSON
          const rows = XLSX.utils.sheet_to_json(worksheet, {
            defval: '',
            raw: true
          });

          return {
            semester,
            rows,
            columns: rows.length > 0 ? Object.keys(rows[0]) : []
          };
        } catch (error) {
          console.error(`Error loading ${semester}:`, error);
          throw error;
        }
      }

      // Semester selector component
      function createSemesterSelector(semesters, onSelect) {
        const container = document.createElement('div');
        container.className = 'mb-6 p-4 bg-white rounded-lg shadow-sm border';

        const title = document.createElement('h1');
        title.className = 'text-xl font-semibold mb-4 text-gray-800';
        title.textContent = 'Student Progress Visualizer';

        const selectContainer = document.createElement('div');
        selectContainer.className = 'flex items-center gap-3';

        const label = document.createElement('label');
        label.className = 'text-sm font-medium text-gray-700';
        label.textContent = 'Select Semester:';

        const select = document.createElement('select');
        select.className =
          'px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Choose a semester...';
        select.appendChild(defaultOption);

        // Add semester options
        semesters.forEach((semester) => {
          const option = document.createElement('option');
          option.value = semester;
          option.textContent = semester;
          select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
          console.log('Semester selected:', e.target.value);
          if (e.target.value) {
            onSelect(e.target.value);
          }
        });

        selectContainer.appendChild(label);
        selectContainer.appendChild(select);

        container.appendChild(title);
        container.appendChild(selectContainer);

        return container;
      }

      // Student visualizer component
      function createStudentVisualizer(students, semester) {
        const container = document.createElement('div');
        container.className = 'space-y-6';

        // Student selector
        const selectorContainer = document.createElement('div');
        selectorContainer.className =
          'p-4 bg-white rounded-lg shadow-sm border';

        const selectorTitle = document.createElement('h2');
        selectorTitle.className = 'text-lg font-semibold mb-3 text-gray-800';
        selectorTitle.textContent = `Students in ${semester}`;

        const selectContainer = document.createElement('div');
        selectContainer.className = 'flex items-center gap-3';

        const label = document.createElement('label');
        label.className = 'text-sm font-medium text-gray-700';
        label.textContent = 'Select Student:';

        const select = document.createElement('select');
        select.className =
          'px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[200px]';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Choose a student...';
        select.appendChild(defaultOption);

        // Add student options (sorted by USN)
        students
          .sort((a, b) => a.id.localeCompare(b.id))
          .forEach((student) => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.id} (${student.name})`;
            select.appendChild(option);
          });

        // Add view mode selector
        const viewModeContainer = document.createElement('div');
        viewModeContainer.className = 'flex items-center gap-2 ml-4';

        const viewModeLabel = document.createElement('label');
        viewModeLabel.className = 'text-sm font-medium text-gray-700';
        viewModeLabel.textContent = 'View Mode:';

        const viewModeSelect = document.createElement('select');
        viewModeSelect.className =
          'px-2 py-1 border border-gray-300 rounded text-sm';
        viewModeSelect.id = 'viewMode';
        const viewPlaceholder = document.createElement('option');
        viewPlaceholder.value = '';
        viewPlaceholder.textContent = 'Choose view...';
        viewPlaceholder.selected = true;
        viewPlaceholder.disabled = true;
        viewModeSelect.appendChild(viewPlaceholder);

        const batchOption = document.createElement('option');
        batchOption.value = 'batch';
        batchOption.textContent = 'Batch Overview';
        viewModeSelect.appendChild(batchOption);

        const studentOption = document.createElement('option');
        studentOption.value = 'student';
        studentOption.textContent = 'Individual Student';
        viewModeSelect.appendChild(studentOption);

        viewModeContainer.appendChild(viewModeLabel);
        viewModeContainer.appendChild(viewModeSelect);

        // Add 10th-12th toggle
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'flex items-center gap-2 ml-4';

        const toggleLabel = document.createElement('label');
        toggleLabel.className = 'text-sm font-medium text-gray-700';
        toggleLabel.textContent = 'Include 10th-12th:';

        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className =
          'w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500';
        toggle.id = 'include1012';

        toggleContainer.appendChild(toggleLabel);
        toggleContainer.appendChild(toggle);

        // Wrap student-specific controls to toggle visibility
        const studentControls = document.createElement('div');
        studentControls.className = 'flex items-center gap-3 ml-4';
        studentControls.appendChild(label);
        studentControls.appendChild(select);
        studentControls.appendChild(toggleContainer);
        studentControls.style.display = 'none';

        // Ask view mode first, then show student controls only if needed
        selectContainer.appendChild(viewModeContainer);
        selectContainer.appendChild(studentControls);

        selectorContainer.appendChild(selectorTitle);
        selectorContainer.appendChild(selectContainer);

        // Student info container
        const infoContainer = document.createElement('div');
        infoContainer.className =
          'p-4 bg-white rounded-lg shadow-sm border mb-4';
        infoContainer.style.display = 'none';

        const infoTitle = document.createElement('h3');
        infoTitle.className = 'text-lg font-semibold mb-3 text-gray-800';
        infoTitle.textContent = 'Student Information';

        const infoContent = document.createElement('div');
        infoContent.className = 'grid grid-cols-2 gap-4 text-sm';

        infoContainer.appendChild(infoTitle);
        infoContainer.appendChild(infoContent);

        // Chart container
        const chartContainer = document.createElement('div');
        chartContainer.className = 'p-4 bg-white rounded-lg shadow-sm border';
        chartContainer.style.display = 'none';
        chartContainer.style.height = '400px';

        const chartTitle = document.createElement('h3');
        chartTitle.className = 'text-lg font-semibold mb-4 text-gray-800';
        chartTitle.textContent = 'Semester Progress';

        const canvas = document.createElement('canvas');
        canvas.id = 'studentChart';
        canvas.style.height = '300px';
        canvas.style.width = '100%';

        chartContainer.appendChild(chartTitle);
        chartContainer.appendChild(canvas);

        let currentChart = null;

        function updateView() {
          const selectedStudentId = select.value;
          const include1012 = toggle.checked;
          const viewMode = viewModeSelect.value;

          // Hide all containers initially
          infoContainer.style.display = 'none';
          chartContainer.style.display = 'none';

          // Show/hide student controls based on view mode
          const studentControls = document.querySelector(
            '.flex.items-center.gap-3.ml-4'
          );
          if (studentControls) {
            studentControls.style.display =
              viewMode === 'student' ? 'flex' : 'none';
          }

          if (viewMode === 'batch') {
            // Show batch overview
            const batchOverview = createBatchOverview(students, semester);
            chartContainer.innerHTML = '';
            chartContainer.appendChild(batchOverview);
            chartContainer.style.display = 'block';
          } else if (viewMode === 'student' && selectedStudentId) {
            // Show individual student view
            const selectedStudent = students.find(
              (s) => s.id === selectedStudentId
            );
            if (!selectedStudent) return;

            infoContainer.style.display = 'block';
            chartContainer.style.display = 'block';

            // Update student info
            infoContent.innerHTML = `
              <div><strong>USN:</strong> ${selectedStudent.id}</div>
              <div><strong>Name:</strong> ${selectedStudent.name}</div>
              <div><strong>Average:</strong> ${getStudentAverage(
                selectedStudent
              )}%</div>
              <div><strong>Backlogs:</strong> ${getStudentBacklogs(
                selectedStudent
              )}</div>
            `;

            // Destroy previous chart if exists
            if (currentChart) {
              currentChart.destroy();
            }

            // Create new chart
            const chartData = prepareChartData(selectedStudent, include1012);

            currentChart = new Chart(canvas, {
              type: 'line',
              data: {
                labels: chartData.labels,
                datasets: [
                  {
                    label: `${selectedStudent.name} - Semester Progress`,
                    data: chartData.values,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top'
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Score/Grade'
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Subjects/Courses'
                    }
                  }
                },
                interaction: {
                  mode: 'nearest',
                  axis: 'x',
                  intersect: false
                }
              }
            });
          }
        }

        container.appendChild(selectorContainer);
        container.appendChild(infoContainer);
        container.appendChild(chartContainer);

        // Add event listeners after everything is set up
        select.addEventListener('change', updateView);
        toggle.addEventListener('change', updateView);
        viewModeSelect.addEventListener('change', updateView);

        return container;
      }

      // Batch overview with heatmap
      function createBatchOverview(students, semester) {
        const container = document.createElement('div');
        container.className = 'space-y-6';

        const title = document.createElement('h2');
        title.className = 'text-xl font-semibold text-gray-800 mb-4';
        title.textContent = `Batch Overview - ${semester}`;

        // Create heatmap container
        const heatmapContainer = document.createElement('div');
        heatmapContainer.className =
          'p-4 bg-white rounded-lg shadow-sm border overflow-x-auto';

        const heatmapTitle = document.createElement('h3');
        heatmapTitle.className = 'text-lg font-semibold mb-4 text-gray-800';
        heatmapTitle.textContent = 'Performance Heatmap';

        const heatmapTable = document.createElement('table');
        heatmapTable.className = 'w-full border-collapse';

        // Get semester columns for all students
        const firstStudent = students[0];
        if (!firstStudent) return container;

        const semesterColumns = getSemesterColumns(firstStudent, false); // Don't include 10th-12th

        // Create header row
        const headerRow = document.createElement('tr');
        headerRow.className = 'border-b';

        // Add student name header
        const nameHeader = document.createElement('th');
        nameHeader.className =
          'p-2 text-left font-semibold text-gray-700 border-r min-w-[120px] sticky left-0 bg-white z-10';
        nameHeader.textContent = 'Student';
        headerRow.appendChild(nameHeader);

        // Add semester headers
        semesterColumns.forEach((col) => {
          const th = document.createElement('th');
          th.className =
            'p-2 text-center font-semibold text-gray-700 border-r min-w-[80px]';
          th.textContent = col;
          headerRow.appendChild(th);
        });

        // Add average header
        const avgHeader = document.createElement('th');
        avgHeader.className =
          'p-2 text-center font-semibold text-gray-700 border-r min-w-[80px]';
        avgHeader.textContent = 'Avg';
        headerRow.appendChild(avgHeader);

        // Add backlog header
        const backlogHeader = document.createElement('th');
        backlogHeader.className =
          'p-2 text-center font-semibold text-gray-700 min-w-[80px]';
        backlogHeader.textContent = 'Backlog';
        headerRow.appendChild(backlogHeader);

        heatmapTable.appendChild(headerRow);

        // Create data rows
        students.forEach((student) => {
          const row = document.createElement('tr');
          row.className = 'border-b hover:bg-gray-50';

          // Student name cell
          const nameCell = document.createElement('td');
          nameCell.className =
            'p-2 text-sm font-medium text-gray-700 border-r sticky left-0 bg-white z-10';
          nameCell.textContent = `${student.id} (${student.name})`;
          row.appendChild(nameCell);

          // Semester data cells
          semesterColumns.forEach((col) => {
            const value = student.data[col];
            const numValue =
              typeof value === 'number' ? value : parseFloat(value) || 0;
            const cell = document.createElement('td');
            cell.className = 'p-2 text-center text-sm border-r';
            cell.textContent = numValue.toFixed(1);

            // Color coding based on performance
            if (numValue >= 85) {
              cell.className += ' bg-green-100 text-green-800';
            } else if (numValue >= 75) {
              cell.className += ' bg-blue-100 text-blue-800';
            } else if (numValue >= 65) {
              cell.className += ' bg-yellow-100 text-yellow-800';
            } else if (numValue >= 50) {
              cell.className += ' bg-orange-100 text-orange-800';
            } else {
              cell.className += ' bg-red-100 text-red-800';
            }

            row.appendChild(cell);
          });

          // Average cell
          const avgCell = document.createElement('td');
          avgCell.className = 'p-2 text-center text-sm font-semibold border-r';
          const avg = getStudentAverage(student);
          avgCell.textContent = avg + '%';
          avgCell.className += getColorClass(parseFloat(avg));
          row.appendChild(avgCell);

          // Backlog cell
          const backlogCell = document.createElement('td');
          backlogCell.className = 'p-2 text-center text-sm';
          const backlog = getStudentBacklogs(student);
          backlogCell.textContent = backlog;
          if (backlog > 0) {
            backlogCell.className += ' bg-red-100 text-red-800 font-semibold';
          } else {
            backlogCell.className += ' bg-green-100 text-green-800';
          }
          row.appendChild(backlogCell);

          heatmapTable.appendChild(row);
        });

        heatmapContainer.appendChild(heatmapTitle);
        heatmapContainer.appendChild(heatmapTable);

        // Add legend
        const legend = document.createElement('div');
        legend.className = 'mt-4 flex flex-wrap gap-4 text-sm';
        legend.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-green-100 border border-green-300"></div>
            <span>85%+ (Excellent)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-blue-100 border border-blue-300"></div>
            <span>75-84% (Good)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-yellow-100 border border-yellow-300"></div>
            <span>65-74% (Average)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-orange-100 border border-orange-300"></div>
            <span>50-64% (Below Average)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-red-100 border border-red-300"></div>
            <span><50% (Poor)</span>
          </div>
        `;

        heatmapContainer.appendChild(legend);
        container.appendChild(title);
        container.appendChild(heatmapContainer);

        return container;
      }

      function getSemesterColumns(student, include1012 = false) {
        const data = student.data;
        const columns = Object.keys(data);

        if (include1012) {
          return [...columns.slice(2, 4), ...columns.slice(4, -3)];
        } else {
          return columns.slice(4, -3);
        }
      }

      function getColorClass(value) {
        if (value >= 85) return ' bg-green-100 text-green-800';
        if (value >= 75) return ' bg-blue-100 text-blue-800';
        if (value >= 65) return ' bg-yellow-100 text-yellow-800';
        if (value >= 50) return ' bg-orange-100 text-orange-800';
        return ' bg-red-100 text-red-800';
      }

      function prepareChartData(student, include1012 = false) {
        const data = student.data;
        const columns = Object.keys(data);

        // Based on structure: Column 1=Name, 2=USN, 3-4=10th-12th, 5 to last-3=semesters, last-2=avg, last=backlog
        let semesterColumns;

        if (include1012) {
          // Include 10th-12th (columns 3-4) + semesters (columns 5 to last-3)
          semesterColumns = [...columns.slice(2, 4), ...columns.slice(4, -3)];
        } else {
          // Only semesters (columns 5 to last-3)
          semesterColumns = columns.slice(4, -3);
        }

        const labels = semesterColumns;
        const values = semesterColumns.map((col) => {
          const value = data[col];
          return typeof value === 'number' ? value : parseFloat(value) || 0;
        });

        return { labels, values };
      }

      function getStudentAverage(student) {
        const data = student.data;
        const columns = Object.keys(data);

        // Last-2 column is average
        if (columns.length >= 2) {
          const avgColumn = columns[columns.length - 2];
          const value = data[avgColumn];
          return typeof value === 'number'
            ? value.toFixed(2)
            : parseFloat(value || 0).toFixed(2);
        }

        return '0.00';
      }

      function getStudentBacklogs(student) {
        const data = student.data;
        const columns = Object.keys(data);

        // Last column is backlog count
        if (columns.length >= 1) {
          const backlogColumn = columns[columns.length - 1];
          const value = data[backlogColumn];
          return typeof value === 'number' ? value : parseFloat(value || 0);
        }

        return 0;
      }

      function extractStudents(data) {
        if (!data || !data.rows || data.rows.length === 0) return [];

        // Based on the structure: Column 1 = Name, Column 2 = USN
        const firstRow = data.rows[0];
        const columns = Object.keys(firstRow);

        // Column 1 is Name, Column 2 is USN
        const nameCol = columns[0]; // First column
        const idCol = columns[1]; // Second column

        return data.rows
          .map((row) => ({
            id: String(row[idCol] || ''), // USN (2nd column)
            name: String(row[nameCol] || ''), // Name (1st column)
            data: row
          }))
          .filter((student) => student.id && student.id.trim() !== '');
      }

      // Initialize the app
      async function init() {
        const appEl = document.getElementById('app');

        // Create semester selector
        const selector = createSemesterSelector(
          ['5thSem', '7thSem'],
          async (semester) => {
            console.log('Loading semester:', semester);
            if (!state.semesterData[semester]) {
              try {
                state.semesterData[semester] = await loadSemesterData(semester);
                state.students = extractStudents(state.semesterData[semester]);
                console.log('Loaded students:', state.students.length);
              } catch (error) {
                console.error('Failed to load semester data:', error);
                return;
              }
            }

            state.currentSemester = semester;
            renderVisualizer();
          }
        );

        appEl.appendChild(selector);

        // Create visualizer container
        const visualizerContainer = document.createElement('div');
        visualizerContainer.id = 'visualizer';
        appEl.appendChild(visualizerContainer);

        function renderVisualizer() {
          if (state.currentSemester && state.students.length > 0) {
            // Create individual student visualizer (default view)
            const studentVisualizer = createStudentVisualizer(
              state.students,
              state.currentSemester
            );

            visualizerContainer.innerHTML = '';
            visualizerContainer.appendChild(studentVisualizer);
          }
        }
      }

      // Start the app
      init();
    </script>
  </body>
</html>
