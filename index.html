<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Progress Visualizer</title>
    <link rel="icon" href="data:," />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>
  <body class="min-h-screen bg-gray-50 p-4">
    <div id="app" class="max-w-7xl mx-auto">
      <!-- Simple semester selector and visualization -->
    </div>

    <script>
      // Simple state management
      const state = {
        currentSemester: null,
        semesterData: {},
        students: [],
        currentStudent: null
      };

      // Data loader
      async function loadSemesterData(semester) {
        const path = `./public/${semester}.xlsx`;

        try {
          const response = await fetch(path);
          if (!response.ok) {
            throw new Error(`Failed to fetch ${path}: ${response.status}`);
          }

          const arrayBuffer = await response.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });

          // Get the first sheet
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];

          // Convert to JSON
          const rows = XLSX.utils.sheet_to_json(worksheet, {
            defval: '',
            raw: true
          });

          return {
            semester,
            rows,
            columns: rows.length > 0 ? Object.keys(rows[0]) : []
          };
        } catch (error) {
          console.error(`Error loading ${semester}:`, error);
          throw error;
        }
      }

      // Semester selector component
      function createSemesterSelector(semesters, onSelect) {
        const container = document.createElement('div');
        container.className =
          'mb-6 p-6 bg-white rounded-lg shadow-md border border-gray-200';

        const title = document.createElement('h1');
        title.className = 'text-2xl font-bold mb-6 text-gray-900';
        title.textContent = 'Student Progress Visualizer';

        const selectContainer = document.createElement('div');
        selectContainer.className = 'flex items-center gap-4';

        const label = document.createElement('label');
        label.className = 'text-sm font-semibold text-gray-700';
        label.textContent = 'Select Semester:';

        const select = document.createElement('select');
        select.className =
          'px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Choose a semester...';
        select.appendChild(defaultOption);

        // Add semester options
        semesters.forEach((semester) => {
          const option = document.createElement('option');
          option.value = semester;
          option.textContent = semester;
          select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
          console.log('Semester selected:', e.target.value);
          if (e.target.value) {
            onSelect(e.target.value);
          }
        });

        selectContainer.appendChild(label);
        selectContainer.appendChild(select);

        container.appendChild(title);
        container.appendChild(selectContainer);

        return container;
      }

      // Student visualizer component
      function createStudentVisualizer(students, semester) {
        const container = document.createElement('div');
        container.className = 'space-y-6';

        // Student selector
        const selectorContainer = document.createElement('div');
        selectorContainer.className =
          'p-6 bg-white rounded-lg shadow-md border border-gray-200';

        const selectorTitle = document.createElement('h2');
        selectorTitle.className = 'text-xl font-bold mb-4 text-gray-900';
        selectorTitle.textContent = `Students in ${semester}`;

        const selectContainer = document.createElement('div');
        selectContainer.className = 'flex items-center gap-4';

        const label = document.createElement('label');
        label.className = 'text-sm font-semibold text-gray-700';
        label.textContent = 'Select Student:';

        const select = document.createElement('select');
        select.className =
          'px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900 min-w-[200px]';

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Choose a student...';
        select.appendChild(defaultOption);

        // Add student options (sorted by USN)
        students
          .sort((a, b) => a.id.localeCompare(b.id))
          .forEach((student) => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = `${student.id} (${student.name})`;
            select.appendChild(option);
          });

        // Add view mode selector
        const viewModeContainer = document.createElement('div');
        viewModeContainer.className = 'flex items-center gap-3';

        const viewModeLabel = document.createElement('label');
        viewModeLabel.className = 'text-sm font-semibold text-gray-700';
        viewModeLabel.textContent = 'View Mode:';

        const viewModeSelect = document.createElement('select');
        viewModeSelect.className =
          'px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-900';
        viewModeSelect.id = 'viewMode';
        const viewPlaceholder = document.createElement('option');
        viewPlaceholder.value = '';
        viewPlaceholder.textContent = 'Choose view...';
        viewPlaceholder.selected = true;
        viewPlaceholder.disabled = true;
        viewModeSelect.appendChild(viewPlaceholder);

        const batchOption = document.createElement('option');
        batchOption.value = 'batch';
        batchOption.textContent = 'Batch Overview';
        viewModeSelect.appendChild(batchOption);

        const studentOption = document.createElement('option');
        studentOption.value = 'student';
        studentOption.textContent = 'Individual Student';
        viewModeSelect.appendChild(studentOption);

        viewModeContainer.appendChild(viewModeLabel);
        viewModeContainer.appendChild(viewModeSelect);

        // Add 10th-12th toggle
        const toggleContainer = document.createElement('div');
        toggleContainer.className = 'flex items-center gap-3 ml-6';

        const toggleLabel = document.createElement('label');
        toggleLabel.className = 'text-sm font-semibold text-gray-700';
        toggleLabel.textContent = 'Include 10th-12th:';

        const toggle = document.createElement('input');
        toggle.type = 'checkbox';
        toggle.className =
          'w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500';
        toggle.id = 'include1012';

        toggleContainer.appendChild(toggleLabel);
        toggleContainer.appendChild(toggle);

        // Wrap student-specific controls to toggle visibility
        const studentControls = document.createElement('div');
        studentControls.className = 'flex items-center gap-4 ml-6';
        studentControls.appendChild(label);
        studentControls.appendChild(select);
        studentControls.appendChild(toggleContainer);
        studentControls.style.display = 'none';

        // Ask view mode first, then show student controls only if needed
        selectContainer.appendChild(viewModeContainer);
        selectContainer.appendChild(studentControls);

        selectorContainer.appendChild(selectorTitle);
        selectorContainer.appendChild(selectContainer);

        // Student info container
        const infoContainer = document.createElement('div');
        infoContainer.className =
          'p-6 bg-white rounded-lg shadow-md border border-gray-200 mb-6';
        infoContainer.style.display = 'none';

        const infoTitle = document.createElement('h3');
        infoTitle.className = 'text-lg font-bold mb-4 text-gray-900';
        infoTitle.textContent = 'Student Information';

        const infoContent = document.createElement('div');
        infoContent.className = 'grid grid-cols-2 gap-6 text-sm';

        infoContainer.appendChild(infoTitle);
        infoContainer.appendChild(infoContent);

        // Chart container
        const chartContainer = document.createElement('div');
        chartContainer.className =
          'p-6 bg-white rounded-lg shadow-md border border-gray-200';
        chartContainer.style.display = 'none';

        const chartTitle = document.createElement('h3');
        chartTitle.className = 'text-lg font-bold mb-4 text-gray-900';
        chartTitle.textContent = 'Semester Progress';

        const canvas = document.createElement('canvas');
        canvas.id = 'studentChart';
        canvas.style.height = '300px';
        canvas.style.width = '100%';

        chartContainer.appendChild(chartTitle);
        chartContainer.appendChild(canvas);

        let currentChart = null;

        function updateView() {
          const selectedStudentId = select.value;
          const include1012 = toggle.checked;
          const viewMode = viewModeSelect.value;

          console.log('updateView called:', {
            selectedStudentId,
            include1012,
            viewMode
          });

          // Hide all containers initially
          infoContainer.style.display = 'none';
          chartContainer.style.display = 'none';

          // Show/hide student controls based on view mode
          const studentControls = document.querySelector(
            '.flex.items-center.gap-4.ml-6'
          );
          if (studentControls) {
            studentControls.style.display =
              viewMode === 'student' ? 'flex' : 'none';
          }

          if (viewMode === 'batch') {
            // Show batch overview
            const batchOverview = createBatchOverview(students, semester);
            chartContainer.innerHTML = '';
            chartContainer.appendChild(batchOverview);
            chartContainer.style.display = 'block';
            chartContainer.style.height = 'unset';
          } else if (viewMode === 'student' && selectedStudentId) {
            // Show individual student view
            console.log('Looking for student with ID:', selectedStudentId);
            const selectedStudent = students.find(
              (s) => s.id === selectedStudentId
            );
            console.log('Found student:', selectedStudent);
            if (!selectedStudent) return;

            infoContainer.style.display = 'block';
            chartContainer.style.display = 'block';
            chartContainer.style.height = 'auto';
            chartContainer.style.position = 'relative';

            // Restore chart container structure for individual student view
            chartContainer.innerHTML = '';
            const chartTitle = document.createElement('h3');
            chartTitle.className = 'text-lg font-bold mb-4 text-gray-900';
            chartTitle.textContent = 'Semester Progress';

            const canvas = document.createElement('canvas');
            canvas.id = 'studentChart';
            canvas.style.width = '100%';
            canvas.style.height = '100%';

            // Create a wrapper div for the canvas with fixed height
            const canvasWrapper = document.createElement('div');
            canvasWrapper.style.height = '500px';
            canvasWrapper.style.width = '100%';
            canvasWrapper.style.position = 'relative';
            canvasWrapper.appendChild(canvas);

            chartContainer.appendChild(chartTitle);
            chartContainer.appendChild(canvasWrapper);

            // Update student info
            infoContent.innerHTML = `
              <div><strong>USN:</strong> ${selectedStudent.id}</div>
              <div><strong>Name:</strong> ${selectedStudent.name}</div>
              <div><strong>Average:</strong> ${getStudentAverage(
                selectedStudent
              )}%</div>
              <div><strong>Backlogs:</strong> ${getStudentBacklogs(
                selectedStudent
              )}</div>
            `;

            // Destroy previous chart if exists
            if (currentChart) {
              currentChart.destroy();
            }

            // Create new chart
            const chartData = prepareChartData(selectedStudent, include1012);

            currentChart = new Chart(canvas, {
              type: 'line',
              data: {
                labels: chartData.labels,
                datasets: [
                  {
                    label: `${selectedStudent.name}`,
                    data: chartData.values,
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 6,
                    pointHoverRadius: 8
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2.5,
                plugins: {
                  legend: {
                    display: true,
                    position: 'top'
                  },
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: 'Score/Grade'
                    }
                  },
                  x: {
                    title: {
                      display: true,
                      text: 'Subjects/Courses'
                    }
                  }
                },
                interaction: {
                  mode: 'nearest',
                  axis: 'x',
                  intersect: false
                }
              }
            });
          }
        }

        container.appendChild(selectorContainer);
        container.appendChild(infoContainer);
        container.appendChild(chartContainer);

        // Add event listeners after everything is set up
        select.addEventListener('change', updateView);
        toggle.addEventListener('change', updateView);
        viewModeSelect.addEventListener('change', (e) => {
          console.log('View mode changed to:', e.target.value);
          updateView();
        });

        return container;
      }

      // Batch overview with heatmap
      function createBatchOverview(students, semester) {
        const container = document.createElement('div');
        container.className = 'space-y-6';

        const title = document.createElement('h2');
        title.className = 'text-xl font-bold text-gray-900 mb-6';
        title.textContent = `Batch Overview - ${semester}`;

        // Create heatmap container
        const heatmapContainer = document.createElement('div');
        heatmapContainer.className =
          'p-6 bg-white rounded-lg shadow-md border border-gray-200 overflow-x-auto';

        const heatmapTitle = document.createElement('h3');
        heatmapTitle.className = 'text-lg font-bold mb-4 text-gray-900';
        heatmapTitle.textContent = 'Performance Heatmap';

        const heatmapTable = document.createElement('table');
        heatmapTable.className = 'w-full border-collapse';

        // Get semester columns for all students
        const firstStudent = students[0];
        if (!firstStudent) return container;

        const semesterColumns = getSemesterColumns(firstStudent, false); // Don't include 10th-12th

        // Create header row
        const headerRow = document.createElement('tr');
        headerRow.className = 'border-b';

        // Add student name header
        const nameHeader = document.createElement('th');
        nameHeader.className =
          'p-3 text-left font-bold text-gray-900 border-r border-gray-300 min-w-[120px] sticky left-0 bg-white z-10';
        nameHeader.textContent = 'Student';
        headerRow.appendChild(nameHeader);

        // Add semester headers
        semesterColumns.forEach((col) => {
          const th = document.createElement('th');
          th.className =
            'p-3 text-center font-bold text-gray-900 border-r border-gray-300 min-w-[80px]';
          th.textContent = col;
          headerRow.appendChild(th);
        });

        // Add average header
        const avgHeader = document.createElement('th');
        avgHeader.className =
          'p-3 text-center font-bold text-gray-900 border-r border-gray-300 min-w-[80px]';
        avgHeader.textContent = 'Avg';
        headerRow.appendChild(avgHeader);

        // Add backlog header
        const backlogHeader = document.createElement('th');
        backlogHeader.className =
          'p-3 text-center font-bold text-gray-900 min-w-[80px]';
        backlogHeader.textContent = 'Backlog';
        headerRow.appendChild(backlogHeader);

        heatmapTable.appendChild(headerRow);

        // Create data rows
        students.forEach((student) => {
          const row = document.createElement('tr');
          row.className = 'border-b border-gray-200 hover:bg-gray-50';

          // Student name cell
          const nameCell = document.createElement('td');
          nameCell.className =
            'p-3 text-sm font-semibold text-gray-900 border-r border-gray-300 sticky left-0 bg-white z-10';
          nameCell.textContent = `${student.id} (${student.name})`;
          row.appendChild(nameCell);

          // Semester data cells
          semesterColumns.forEach((col) => {
            const value = student.data[col];
            const numValue =
              typeof value === 'number' ? value : parseFloat(value) || 0;
            const cell = document.createElement('td');
            cell.className = 'p-3 text-center text-sm border-r border-gray-300';
            cell.textContent = numValue.toFixed(1);

            // Color coding based on performance
            if (numValue >= 85) {
              cell.className += ' bg-emerald-100 text-emerald-800';
            } else if (numValue >= 75) {
              cell.className += ' bg-blue-100 text-blue-800';
            } else if (numValue >= 65) {
              cell.className += ' bg-amber-100 text-amber-800';
            } else if (numValue >= 50) {
              cell.className += ' bg-orange-100 text-orange-800';
            } else {
              cell.className += ' bg-red-100 text-red-800';
            }

            row.appendChild(cell);
          });

          // Average cell
          const avgCell = document.createElement('td');
          avgCell.className =
            'p-3 text-center text-sm font-bold border-r border-gray-300';
          const avg = getStudentAverage(student);
          avgCell.textContent = avg + '%';
          avgCell.className += getColorClass(parseFloat(avg));
          row.appendChild(avgCell);

          // Backlog cell
          const backlogCell = document.createElement('td');
          backlogCell.className = 'p-3 text-center text-sm';
          const backlog = getStudentBacklogs(student);
          backlogCell.textContent = backlog;
          if (backlog > 0) {
            backlogCell.className += ' bg-red-100 text-red-800 font-bold';
          } else {
            backlogCell.className += ' bg-emerald-100 text-emerald-800';
          }
          row.appendChild(backlogCell);

          heatmapTable.appendChild(row);
        });

        heatmapContainer.appendChild(heatmapTitle);
        heatmapContainer.appendChild(heatmapTable);

        // Add legend
        const legend = document.createElement('div');
        legend.className = 'mt-6 flex flex-wrap gap-6 text-sm';
        legend.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-emerald-100 border border-emerald-300 rounded"></div>
            <span class="font-medium">85%+ (Excellent)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div>
            <span class="font-medium">75-84% (Good)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-amber-100 border border-amber-300 rounded"></div>
            <span class="font-medium">65-74% (Average)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-orange-100 border border-orange-300 rounded"></div>
            <span class="font-medium">50-64% (Below Average)</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
            <span class="font-medium"><50% (Poor)</span>
          </div>
        `;

        heatmapContainer.appendChild(legend);
        container.appendChild(title);
        container.appendChild(heatmapContainer);

        return container;
      }

      function getSemesterColumns(student, include1012 = false) {
        const data = student.data;
        const columns = Object.keys(data);

        if (include1012) {
          // Include 10th-12th (columns 2-3) + semesters (columns 4 to last-1 or last-2)
          const hasAverage = columns.length > 10; // 7th sem has 12 columns, 5th sem has 9
          const semesterEnd = hasAverage ? -2 : -1;
          return [...columns.slice(2, 4), ...columns.slice(4, semesterEnd)];
        } else {
          // Only semesters (columns 4 to last-1 or last-2, excluding average and backlog)
          const hasAverage = columns.length > 10; // 7th sem has 12 columns, 5th sem has 9
          const semesterEnd = hasAverage ? -2 : -1;
          return columns.slice(4, semesterEnd);
        }
      }

      function getColorClass(value) {
        if (value >= 85) return ' bg-emerald-100 text-emerald-800';
        if (value >= 75) return ' bg-blue-100 text-blue-800';
        if (value >= 65) return ' bg-amber-100 text-amber-800';
        if (value >= 50) return ' bg-orange-100 text-orange-800';
        return ' bg-red-100 text-red-800';
      }

      function prepareChartData(student, include1012 = false) {
        const data = student.data;
        const columns = Object.keys(data);

        // Based on structure: Column 1=Name, 2=USN, 3-4=10th-12th, 5 to last-1 or last-2=semesters, last or last-1=backlog
        let semesterColumns;

        if (include1012) {
          // Include 10th-12th (columns 3-4) + semesters (columns 5 to last-1 or last-2)
          const hasAverage = columns.length > 10; // 7th sem has 12 columns, 5th sem has 9
          const semesterEnd = hasAverage ? -2 : -1;
          semesterColumns = [
            ...columns.slice(2, 4),
            ...columns.slice(4, semesterEnd)
          ];
        } else {
          // Only semesters (columns 5 to last-1 or last-2)
          const hasAverage = columns.length > 10; // 7th sem has 12 columns, 5th sem has 9
          const semesterEnd = hasAverage ? -2 : -1;
          semesterColumns = columns.slice(4, semesterEnd);
        }

        const labels = semesterColumns;
        const values = semesterColumns.map((col) => {
          const value = data[col];
          return typeof value === 'number' ? value : parseFloat(value) || 0;
        });

        return { labels, values };
      }

      function getStudentAverage(student) {
        const data = student.data;
        const columns = Object.keys(data);

        // Check if there's a pre-calculated average column (7th sem has it, 5th sem doesn't)
        const hasAverage = columns.length > 10; // 7th sem has 12 columns, 5th sem has 9

        if (hasAverage) {
          // Use the pre-calculated average column (second to last)
          const avgColumn = columns[columns.length - 2];
          const value = data[avgColumn];
          return typeof value === 'number'
            ? value.toFixed(2)
            : parseFloat(value || 0).toFixed(2);
        } else {
          // Calculate average from semester columns (excluding 10th-12th and backlog)
          const semesterColumns = columns.slice(4, -1); // From index 4 to last-1
          const semesterValues = semesterColumns
            .map((col) => {
              const value = data[col];
              return typeof value === 'number' ? value : parseFloat(value) || 0;
            })
            .filter((val) => val > 0); // Filter out zero/empty values

          if (semesterValues.length > 0) {
            const average =
              semesterValues.reduce((sum, val) => sum + val, 0) /
              semesterValues.length;
            return average.toFixed(2);
          }
        }

        return '0.00';
      }

      function getStudentBacklogs(student) {
        const data = student.data;
        const columns = Object.keys(data);

        // Last column is backlog count
        if (columns.length >= 1) {
          const backlogColumn = columns[columns.length - 1];
          const value = data[backlogColumn];
          return typeof value === 'number' ? value : parseFloat(value || 0);
        }

        return 0;
      }

      function extractStudents(data) {
        if (!data || !data.rows || data.rows.length === 0) return [];

        // Based on the structure: Column 1 = Name, Column 2 = USN
        const firstRow = data.rows[0];
        const columns = Object.keys(firstRow);

        // Column 1 is Name, Column 2 is USN
        const nameCol = columns[0]; // First column
        const idCol = columns[1]; // Second column

        return data.rows
          .map((row) => ({
            id: String(row[idCol] || ''), // USN (2nd column)
            name: String(row[nameCol] || ''), // Name (1st column)
            data: row
          }))
          .filter((student) => student.id && student.id.trim() !== '');
      }

      // Initialize the app
      async function init() {
        const appEl = document.getElementById('app');

        // Create semester selector
        const selector = createSemesterSelector(
          ['5th-Sem', '7th-Sem'],
          async (semester) => {
            console.log('Loading semester:', semester);
            if (!state.semesterData[semester]) {
              try {
                state.semesterData[semester] = await loadSemesterData(semester);
                state.students = extractStudents(state.semesterData[semester]);
                console.log('Loaded students:', state.students.length);
              } catch (error) {
                console.error('Failed to load semester data:', error);
                return;
              }
            }

            state.currentSemester = semester;
            renderVisualizer();
          }
        );

        appEl.appendChild(selector);

        // Create visualizer container
        const visualizerContainer = document.createElement('div');
        visualizerContainer.id = 'visualizer';
        appEl.appendChild(visualizerContainer);

        function renderVisualizer() {
          if (state.currentSemester && state.students.length > 0) {
            // Create individual student visualizer (default view)
            const studentVisualizer = createStudentVisualizer(
              state.students,
              state.currentSemester
            );

            visualizerContainer.innerHTML = '';
            visualizerContainer.appendChild(studentVisualizer);
          }
        }
      }

      // Start the app
      init();
    </script>
  </body>
</html>
